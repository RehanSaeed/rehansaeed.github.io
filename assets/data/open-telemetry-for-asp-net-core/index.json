{"hash":"0d49db6b3441242938fbe659d74dd64735a41d33","data":{"post":{"title":"Open Telemetry for ASP.NET Core","path":"/open-telemetry-for-asp-net-core/","date":"2021-02-01T00:00:00+00:00","dateModified":null,"timeToRead":3,"author":"Muhammad Rehan Saeed","headings":[{"value":"The Simplest Setup"},{"value":"The Trace Output"},{"value":"Up Next"}],"tags":[{"id":"Open Telemetry","title":"Open Telemetry","path":"/tag/open-telemetry/"},{"id":".NET","title":".NET","path":"/tag/net/"},{"id":".NET Core","title":".NET Core","path":"/tag/net-core/"},{"id":"ASP.NET Core","title":"ASP.NET Core","path":"/tag/asp-net-core/"},{"id":"Metrics","title":"Metrics","path":"/tag/metrics/"},{"id":"Logging","title":"Logging","path":"/tag/logging/"},{"id":"Tracing","title":"Tracing","path":"/tag/tracing/"},{"id":"Distributed Tracing","title":"Distributed Tracing","path":"/tag/distributed-tracing/"},{"id":"Span","title":"Span","path":"/tag/span/"},{"id":"Activity","title":"Activity","path":"/tag/activity/"}],"description":"The basics of how to configure Open Telemetry metrics, logs, and traces for ASP.NET Core and export the traces.","content":"<ol>\n<li><a href=\"/deep-dive-into-open-telemetry-for-net/\">Open Telemetry - Deep Dive into Open Telemetry for .NET</a></li>\n<li><a href=\"/open-telemetry-for-asp-net-core/\">Open Telemetry - Configuring Open Telemetry for ASP.NET Core</a></li>\n<li><a href=\"/exporting-open-telemetry-data-to-jaeger/\">Open Telemetry - Exporting Open Telemetry Data to Jaeger</a></li>\n<li><a href=\"/optimally-configuring-open-telemetry-tracing-for-asp-net-core/\">Open Telemetry - Optimally Configuring Open Telemetry Tracing for ASP.NET Core</a></li>\n</ol>\n<p>Configuring Open Telemetry for ASP.NET Core is a fairly simple process. In this post, I'll show you the simplest setup for tracing Open Telemetry in ASP.NET Core and then move to a more fully featured example.</p>\n<p>To begin with, we'll just be exporting our Open Telemetry traces to the debug output so we can see what is being recorded but we'll soon move on to exporting to Jaeger in another post where we can see nice visualisations of our traces.</p>\n<h1 id=\"the-simplest-setup\"><a href=\"#the-simplest-setup\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Simplest Setup</h1>\n<p>Open Telemetry for ASP.NET Core ships as several NuGet packages. The <code class=\"language-inline-text\">OpenTelemetry.Extensions.Hosting</code> package is the required core package to add Open Telemetry to your application.</p>\n<p>You can optionally add packages beginning with <code class=\"language-inline-text\">OpenTelemetry.Instrumentation.*</code> to collect extra span attributes e.g. the <code class=\"language-inline-text\">OpenTelemetry.Instrumentation.AspNetCore</code> package adds span attributes for the current request and response.</p>\n<p>You can also optionally add packages beginning with <code class=\"language-inline-text\">OpenTelemetry.Exporter.*</code> to export trace data e.g. the <code class=\"language-inline-text\">OpenTelemetry.Exporter.Console</code> package exports all trace data to the console or debug output of your application.</p>\n<div class=\"line-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span> <span class=\"token attr-name\">Label</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Package References<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>OpenTelemetry.Exporter.Console<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1.0.1<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>OpenTelemetry.Extensions.Hosting<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1.0.0-rc2<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>OpenTelemetry.Instrumentation.AspNetCore<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1.0.0-rc2<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>In our <code class=\"language-inline-text\">Program.cs</code> I've added a <code class=\"language-inline-text\">ConfigureServices</code> method, where we can add Open Telemetry support with just a few lines of code using the <code class=\"language-inline-text\">AddOpenTelemetryTracing</code> method.</p>\n<div class=\"line-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">virtual</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">IWebHostEnvironment</span> webHostEnvironment<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...omitted</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddOpenTelemetryTracing</span><span class=\"token punctuation\">(</span>\n        builder <span class=\"token operator\">=></span>\n        <span class=\"token punctuation\">{</span>\n            builder\n                <span class=\"token punctuation\">.</span><span class=\"token function\">SetResourceBuilder</span><span class=\"token punctuation\">(</span>ResourceBuilder\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">CreateDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">AddService</span><span class=\"token punctuation\">(</span>webHostEnvironment<span class=\"token punctuation\">.</span>ApplicationName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">AddAspNetCoreInstrumentation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>webHostEnvironment<span class=\"token punctuation\">.</span><span class=\"token function\">IsDevelopment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddConsoleExporter</span><span class=\"token punctuation\">(</span>\n                    options <span class=\"token operator\">=></span> options<span class=\"token punctuation\">.</span>Targets <span class=\"token operator\">=</span> ConsoleExporterOutputTargets<span class=\"token punctuation\">.</span>Debug<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-inline-text\">SetResourceBuilder</code> method is your opportunity to add a set of common attributes to all spans created in the application. In the above case, we've added an application name.</p>\n<p>The <code class=\"language-inline-text\">AddAspNetCoreInstrumentation</code> method is where we enable collection of attributes relating to ASP.NET Core requests and responses.</p>\n<p>Finally, we use <code class=\"language-inline-text\">AddConsoleExporter</code> to export the trace data to the debug output. You could also output to the console but there is a lot of trace data and the console is already outputting log information which results in duplication, so I prefer not to do that. Note that we only do this if we are running in the development environment.</p>\n<h1 id=\"the-trace-output\"><a href=\"#the-trace-output\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Trace Output</h1>\n<p>If we now start the application and execute a request/response cycle, we can see the following in our IDE's debug output window:</p>\n<div class=\"line-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Activity.Id:          00-dde96d459fee4144a83818e054e221b1-cac69896c1bcd14f-01\nActivity.DisplayName: /favicon-32x32.png\nActivity.Kind:        Server\nActivity.StartTime:   2021-02-01T10:28:25.4637044Z\nActivity.Duration:    00:00:00.0086712\nActivity.TagObjects:\n    http.host: localhost:5001\n    http.method: GET\n    http.path: /favicon-32x32.png\n    http.url: https://localhost:5001/favicon-32x32.png\n    http.user_agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.104 Safari/537.36\n    http.status_code: 200\n    otel.status_code: UNSET\n    service.name: ApiTemplate\n    service.instance.id: defe9269-04f2-4b49-a05c-ebddf2112993\n    telemetry.sdk.name: opentelemetry\n    telemetry.sdk.language: dotnet\n    telemetry.sdk.version: 1.0.0.0</code></pre></div>\n<p>The first few lines give us some basic information about the span, including the span ID, start time and duration of the span. Under TagObjects is where we can see all attributes assigned to the span.</p>\n<p>All attributes starting with <code class=\"language-inline-text\">http</code> tell us about the request and response while the attributes starting with <code class=\"language-inline-text\">service</code> tell us about the application itself. This includes a unique identifier for the current instance of the application. This can be useful if we were running multiple instances of the application in Kubernetes or Docker Swarm for example.</p>\n<p>Finally, we also get quite a lot of information about the Open Telemetry library used to collect the information. It may eventually be useful when multiple versions of the Open Telemetry protocol are released and there is some feature difference between them but as of now, it's not very useful. I haven't been able to find a way to turn it off, since it's a fair amount of information to send in absolutely every trace message.</p>\n<h1 id=\"up-next\"><a href=\"#up-next\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Up Next</h1>\n<p>I've shown a basic example of setting up Open Telemetry and discussed the defaults of what trace data is collected in ASP.NET Core. In my next post, I'll cover how you can fire up Jaeger and show how you can get an ASP.NET Core app to export Open Telemetry data to it.</p>\n","heroImage":"/images/hero/Open-Telemetry-1600x900.png"}},"context":{}}