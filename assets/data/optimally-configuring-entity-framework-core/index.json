{"hash":"28e3ef7605772f0f3b809c72e6cdc9a35d8610d5","data":{"post":{"title":"Optimally Configuring Entity Framework Core","path":"/optimally-configuring-entity-framework-core/","date":"2018-07-08T00:00:00+00:00","dateModified":null,"timeToRead":3,"author":"Muhammad Rehan Saeed","headings":[{"value":"EnableRetryOnFailure"},{"value":"ConfigureWarnings"},{"value":"EnableSensitiveDataLogging"},{"value":"UseQueryTrackingBehavior"},{"value":"Connection Strings"},{"value":"Application Name"},{"value":"Min Pool Size"},{"value":"The End..."}],"tags":[{"id":"Connection Strings","title":"Connection Strings","path":"/tag/connection-strings/"},{"id":"Entity Framework Core","title":"Entity Framework Core","path":"/tag/entity-framework-core/"},{"id":"Microsoft SQL Server","title":"Microsoft SQL Server","path":"/tag/microsoft-sql-server/"}],"description":"How to optimally configure your Entity Framework Core DbContext for best performance, resiliency and easy debugging for the developer.","content":"<p>Lets talk about configuring your Entity Framework Core <code class=\"language-inline-text\">DbContext</code> for a moment. There are several options you might want to consider turning on. This is how I configure mine in most micro services:</p>\n<div class=\"line-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">virtual</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddDbContextPool</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>MyDbContext<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>\n        options <span class=\"token operator\">=></span> options\n            <span class=\"token punctuation\">.</span><span class=\"token function\">UseSqlServer</span><span class=\"token punctuation\">(</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>databaseSettings<span class=\"token punctuation\">.</span>ConnectionString<span class=\"token punctuation\">,</span>\n                x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span><span class=\"token function\">EnableRetryOnFailure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">ConfigureWarnings</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span><span class=\"token function\">Throw</span><span class=\"token punctuation\">(</span>RelationalEventId<span class=\"token punctuation\">.</span>QueryClientEvaluationWarning<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">EnableSensitiveDataLogging</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>hostingEnvironment<span class=\"token punctuation\">.</span><span class=\"token function\">IsDevelopment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">UseQueryTrackingBehavior</span><span class=\"token punctuation\">(</span>QueryTrackingBehavior<span class=\"token punctuation\">.</span>NoTracking<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h1 id=\"enableretryonfailure\"><a href=\"#enableretryonfailure\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EnableRetryOnFailure</h1>\n<p><a href=\"https://docs.microsoft.com/en-us/ef/core/miscellaneous/connection-resiliency\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">EnableRetryOnFailure</a> enables retries for transient exceptions. So what is a transient exception? Entity Framework Core has a <code class=\"language-inline-text\">SqlServerTransientExceptionDetector</code> class that defines that. It turns out that any <code class=\"language-inline-text\">SqlException</code> with a very specific list of SQL error codes or <code class=\"language-inline-text\">TimeoutExceptions</code> are considered transient exceptions and thus, safe to retry.</p>\n<h1 id=\"configurewarnings\"><a href=\"#configurewarnings\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ConfigureWarnings</h1>\n<p>By default, Entity Framework Core will log warnings when it can't translate your C# LINQ code to SQL and it will evaluate parts of your LINQ query it does not understand in-memory. This is usually catastrophic for performance because this usually means that EF Core will retrieve a huge amount of data from the database and then filter it down in-memory.</p>\n<p>Luckily in EF Core 2.1, they added support to translate the <code class=\"language-inline-text\">GroupBy</code> LINQ method to SQL. However, I found out yesterday that you have to write Where clauses after <code class=\"language-inline-text\">GroupBy</code> for this to work. If you write the Where clause before your <code class=\"language-inline-text\">GroupBy</code>, EF Core will evaluate your <code class=\"language-inline-text\">GroupBy</code> in-memory in the client instead of in SQL. The key is to know when this is happening.</p>\n<p>One thing you can do is throw an exception when you are evaluating a query in-memory instead of in SQL. That is what Throw on <code class=\"language-inline-text\">QueryClientEvaluationWarning</code> is doing.</p>\n<h1 id=\"enablesensitivedatalogging\"><a href=\"#enablesensitivedatalogging\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EnableSensitiveDataLogging</h1>\n<p><a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontextoptionsbuilder.enablesensitivedatalogging?view=efcore-2.1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">EnableSensitiveDataLogging</a> enables application data to be included in exception messages. This can include SQL, secrets and other sensitive information, so I am only doing it when running in the development environment. It's useful to see warnings and errors coming from Entity Framework Core in the console window when I am debugging my application using the Kestrel webserver directly, instead of with IIS Express.</p>\n<h1 id=\"usequerytrackingbehavior\"><a href=\"#usequerytrackingbehavior\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UseQueryTrackingBehavior</h1>\n<p>If you are building an ASP.NET Core API, each request creates a new instance of your <code class=\"language-inline-text\">DbContext</code> and then this is disposed at the end of the request. Query tracking keeps track of entities in memory for the lifetime of your <code class=\"language-inline-text\">DbContext</code> so that if they are updated any changes can be saved, this is a waste of resources if you are just going to throw away the <code class=\"language-inline-text\">DbContext</code> at the end of the request. By passing NoTracking to the <a href=\"https://docs.microsoft.com/en-us/ef/core/querying/tracking#no-tracking-queries\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">UseQueryTrackingBehavior</a> method, you can turn off this default behaviour. Note that if you are performing updates to your entities, don't use this option, this is only for API's that perform reads and/or inserts.</p>\n<h1 id=\"connection-strings\"><a href=\"#connection-strings\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Connection Strings</h1>\n<p>You can also pass certain settings to connection strings. These are specific to the database you are using, here I'm talking about SQL Server. Here is an example of a connection string:</p>\n<div class=\"line-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Data Source=localhost;Initial Catalog=MyDatabase;Integrated Security=True;Min Pool Size=3;Application Name=MyApplication</code></pre></div>\n<h2 id=\"application-name\"><a href=\"#application-name\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Application Name</h2>\n<p>SQL Server can log or profile queries that are running through it. If you set the application name, you can more easily identify the applications that may be causing problems in your database with slow or failing queries.</p>\n<h2 id=\"min-pool-size\"><a href=\"#min-pool-size\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Min Pool Size</h2>\n<p>Creating database connections is an expensive process that takes time. You can specify that you want a minimum pool of connections that should be created and kept open for the lifetime of the application. These are then reused for each database call. Ideally, you need to performance test with different values and see what works for you. Failing that you need to know how many concurrent connections you want to support at any one time.</p>\n<h1 id=\"the-end\"><a href=\"#the-end\" aria-hidden=\"true\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"22\" height=\"22\" aria-hidden=\"true\"><path fill=\"currentColor\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The End...</h1>\n<p>It took me a while to craft this setup, I hope you find it useful. You can find out more by reading the excellent Entity Framework Core <a href=\"https://docs.microsoft.com/en-us/ef/core/miscellaneous/configuring-dbcontext\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">docs</a>.</p>\n","heroImage":"/images/hero/Microsoft-.NET-1366x768.png"}},"context":{}}