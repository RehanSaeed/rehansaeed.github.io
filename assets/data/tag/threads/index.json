{"hash":"621c04801461263b68379d3a0e8e067096e7a51e","data":{"tag":{"title":"Threads","path":"/tag/threads/","belongsTo":{"edges":[{"node":{"title":"ConfigureAwait in Task Parallel Library (TPL)","path":"/configureawait-task-parallel-library/","date":"07 February 2014","timeToRead":2,"description":"The importance of using ConfigureAwait when using the Task Parallel Library (TPL) to improve performance and reduce context switching.","content":"<p>The Task Parallel Library in conjunction with the <code class=\"language-text\">async</code> and <code class=\"language-text\">await</code> keywords are great but there are some subtleties which you should consider. One of these is the use of the ConfigureAwait method.</p>\n<p>If I wanted to get a list of the titles of the new posts from my RSS feed I could write the following code:</p>\n<div class=\"line-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> Task<span class=\"token operator\">&lt;</span>IEnumerable<span class=\"token operator\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token operator\">>></span> <span class=\"token function\">GetBlogTitles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Current Thread = UI Thread</span>\n    <span class=\"token class-name\">HttpClient</span> httpClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// GetStringAsync = ThreadPool Thread</span>\n    <span class=\"token keyword\">string</span> rss <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> httpClient<span class=\"token punctuation\">.</span><span class=\"token function\">GetStringAsync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://rehansaeed.com/feed/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Current Thread = UI Thread</span>\n    List<span class=\"token operator\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token operator\">></span> blogTitles <span class=\"token operator\">=</span> XDocument<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span>rss<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Descendants</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Elements</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">ToList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Current Thread = UI Thread</span>\n    <span class=\"token keyword\">return</span> blogTitles<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token class-name\">Task</span> <span class=\"token function\">UpdateUserInterface</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Current Thread = UI Thread</span>\n    IEnumerable<span class=\"token operator\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token operator\">></span> blogTitles <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetBlogTitles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Current Thread = UI Thread</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ListBox<span class=\"token punctuation\">.</span>ItemsSource <span class=\"token operator\">=</span> blogTitles<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If I was to call this method, then the entire method would execute on the calling thread except the bit where we call <code class=\"language-text\">GetStringAsync</code> which would go off and do its work on the ThreadPool thread and then we come back onto the original thread and do all our XML manipulation.</p>\n<p>Now if this was a client WPF or WinRT application which has a UI thread, all of the XML manipulation we are doing would be done on the UI thread. This is placing extra burden on the UI thread which could mean application freeze ups if the UI thread is being heavily taxed. The solution is simple, we add <code class=\"language-text\">ConfigureAwait(false)</code> to the end of the call we are making to get the RSS XML. So now our new code looks like this:</p>\n<div class=\"line-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> Task<span class=\"token operator\">&lt;</span>IEnumerable<span class=\"token operator\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token operator\">>></span> <span class=\"token function\">GetBlogTitles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Current Thread = UI Thread</span>\n    <span class=\"token class-name\">HttpClient</span> httpClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// GetStringAsync = ThreadPool Thread</span>\n    <span class=\"token keyword\">string</span> rss <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> httpClient<span class=\"token punctuation\">.</span><span class=\"token function\">GetStringAsync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://rehansaeed.com/feed/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ConfigureAwait</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Current Thread = ThreadPool Thread</span>\n    List<span class=\"token operator\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token operator\">></span> blogTitles <span class=\"token operator\">=</span> XDocument<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span>rss<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Descendants</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Elements</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">ToList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Current Thread = ThreadPool Thread</span>\n    <span class=\"token keyword\">return</span> blogTitles<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token class-name\">Task</span> <span class=\"token function\">UpdateUserInterface</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Current Thread = UI Thread</span>\n    IEnumerable<span class=\"token operator\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token operator\">></span> blogTitles <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetBlogTitles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Current Thread = UI Thread</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ListBox<span class=\"token punctuation\">.</span>ItemsSource <span class=\"token operator\">=</span> blogTitles<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So now all our XML manipulation is done on the <code class=\"language-text\">ThreadPool</code> thread along with the HTTP GET we are doing using the <code class=\"language-text\">HttpClient</code>. Notice however, that when we return the blog titles to the calling method we are back on the UI thread. Each time you do an <code class=\"language-text\">await</code>, the default behaviour is to continue on the thread we started with. By adding <code class=\"language-text\">ConfigureAwait(false)</code>, we are overriding this behaviour to continue on whatever thread the Task was running on.</p>\n<p>For more on the Task Parallel Library (TPL) I highly recommend reading <a href=\"http://blogs.msdn.com/b/toub/\" title=\"Stephen Toub&#x27;s\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Stephen Toub's</a> blog.</p>\n"}}]}}},"context":{}}